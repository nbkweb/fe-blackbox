<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction History - Black Rock Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white; color: black; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b-4 border-purple-600 no-print">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="bg-purple-600 p-3 rounded-xl">
                        <i class="fas fa-history text-white text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">BLACK ROCK TERMINAL</h1>
                        <p class="text-sm text-gray-600">Transaction History & Reports</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <a href="/dashboard" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-semibold">
                        <i class="fas fa-home mr-2"></i>DASHBOARD
                    </a>
                    <a href="/terminal" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-semibold">
                        <i class="fas fa-credit-card mr-2"></i>TERMINAL
                    </a>
                    <button onclick="printTransactions()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-xl font-semibold">
                        <i class="fas fa-print mr-2"></i>PRINT ALL
                    </button>
                    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-xl font-semibold">
                        <i class="fas fa-power-off mr-2"></i>LOGOUT
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Transaction History Content -->
    <main class="container mx-auto px-6 py-8">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="bg-purple-600 text-white px-8 py-6">
                <h2 class="text-2xl font-bold">
                    <i class="fas fa-history mr-2"></i>TRANSACTION HISTORY
                </h2>
                <p class="text-purple-100">Complete transaction records with real-time updates</p>
            </div>

            <!-- Filters -->
            <div class="p-8 border-b bg-gray-50 no-print">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Start Date</label>
                        <input type="date" id="startDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">End Date</label>
                        <input type="date" id="endDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Status</label>
                        <select id="statusFilter" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            <option value="">All Status</option>
                            <option value="approved">Approved</option>
                            <option value="declined">Declined</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Search</label>
                        <input type="text" id="searchQuery" placeholder="Transaction ID..." 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    </div>
                    <div class="flex items-end">
                        <button onclick="filterTransactions()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-bold">
                            <i class="fas fa-filter mr-2"></i>FILTER
                        </button>
                    </div>
                </div>
            </div>

            <!-- Real-time Updates Section -->
            <div class="p-8 border-b bg-blue-50 no-print">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-green-50 rounded-xl p-4 border border-green-200">
                        <h4 class="font-bold text-green-800 mb-2">
                            <i class="fas fa-check-circle mr-2"></i>MTI Acknowledgements
                        </h4>
                        <div id="mtiUpdatesHistory" class="text-sm space-y-1 max-h-24 overflow-y-auto">
                            <p class="text-green-600">Monitoring MTI acknowledgements...</p>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                        <h4 class="font-bold text-blue-800 mb-2">
                            <i class="fas fa-wallet mr-2"></i>Payout Updates
                        </h4>
                        <div id="payoutUpdatesHistory" class="text-sm space-y-1 max-h-24 overflow-y-auto">
                            <p class="text-blue-600">Monitoring payout processing...</p>
                        </div>
                    </div>

                    <div class="bg-orange-50 rounded-xl p-4 border border-orange-200">
                        <h4 class="font-bold text-orange-800 mb-2">
                            <i class="fas fa-link mr-2"></i>Payment References
                        </h4>
                        <div id="referencesHistory" class="text-sm space-y-1 max-h-24 overflow-y-auto">
                            <p class="text-orange-600">Bank/Blockchain references...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transactions Table -->
            <div class="p-8">
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-200">
                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-900">Transaction ID</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-900">Date/Time</th>
                                <th class="px-6 py-4 text-right text-sm font-bold text-gray-900">Amount</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-900">Card</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-900">Status</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-900">Payout</th>
                                <th class="px-6 py-4 text-center text-sm font-bold text-gray-900 no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTable">
                            <tr>
                                <td colspan="7" class="text-center py-12">
                                    <i class="fas fa-spinner fa-spin text-gray-400 text-3xl mb-4"></i>
                                    <p class="text-gray-500 text-lg">Loading transactions...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="flex justify-between items-center mt-8 pt-6 border-t border-gray-200 no-print">
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-700">
                            Showing <span id="showingFrom">0</span> to <span id="showingTo">0</span> of <span id="totalRecords">0</span> transactions
                        </span>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="previousPage()" id="prevBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium" disabled>
                            <i class="fas fa-chevron-left mr-1"></i>Previous
                        </button>
                        <span id="pageInfo" class="px-4 py-2 bg-gray-100 rounded-lg font-medium text-gray-700">Page 1 of 1</span>
                        <button onclick="nextPage()" id="nextBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium" disabled>
                            Next<i class="fas fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentPage = 1;
        let socket = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadTransactions();
            initializeSocket();
            
            // Set default date range (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        });

        function initializeSocket() {
            socket = io('https://black-rock-be.onrender.com', {
                auth: { token: localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token') }
            });

            socket.on('connect', function() {
                addHistoryUpdate('mti', '✅ Connected to real-time updates');
            });

            socket.on('mti_acknowledgement', function(data) {
                addHistoryUpdate('mti', `🔄 MTI ${data.mti} acknowledged: ${data.transaction_id}`);
                // Refresh transactions to show latest status
                loadTransactions();
            });

            socket.on('payout_notification', function(data) {
                addHistoryUpdate('payout', `💰 Payout ${data.payout_status}: $${data.amount} ${data.currency}`);
                if (data.payout_reference) {
                    addHistoryUpdate('reference', `📎 Reference: ${data.payout_reference.substring(0, 15)}...`);
                }
                // Refresh transactions to show latest payout status
                loadTransactions();
            });

            socket.on('transaction_update', function(data) {
                addHistoryUpdate('mti', `📊 Transaction ${data.transaction_id} updated: ${data.status}`);
                // Refresh transactions
                loadTransactions();
            });
        }

        async function loadTransactions() {
            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    start_date: document.getElementById('startDate').value,
                    end_date: document.getElementById('endDate').value,
                    status: document.getElementById('statusFilter').value,
                    search: document.getElementById('searchQuery').value
                });

                const response = await fetch(`/api/proxy/transactions?${params}`);
                if (response.ok) {
                    const data = await response.json();
                    updateTransactionsTable(data.transactions || []);
                    updatePagination(data.pagination || {});
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                showError('Failed to load transactions');
            }
        }

        function updateTransactionsTable(transactions) {
            const tbody = document.getElementById('transactionsTable');
            tbody.innerHTML = '';

            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-gray-300 text-3xl mb-2"></i>
                            <p>No transactions found</p>
                        </td>
                    </tr>
                `;
                return;
            }

            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                const statusColor = transaction.status === 'approved' ? 'bg-green-100 text-green-800' : 
                                  transaction.status === 'declined' ? 'bg-red-100 text-red-800' : 
                                  'bg-yellow-100 text-yellow-800';
                
                const payoutColor = transaction.payout_status === 'completed' ? 'bg-green-100 text-green-800' : 
                                   transaction.payout_status === 'processing' ? 'bg-blue-100 text-blue-800' : 
                                   transaction.payout_status === 'failed' ? 'bg-red-100 text-red-800' :
                                   'bg-yellow-100 text-yellow-800';
                
                row.innerHTML = `
                    <td class="px-6 py-3 font-mono text-sm font-bold">${transaction.transaction_id}</td>
                    <td class="px-6 py-3 text-sm">${new Date(transaction.created_at).toLocaleString()}</td>
                    <td class="px-6 py-3 text-right font-bold">$${transaction.amount} ${transaction.currency}</td>
                    <td class="px-6 py-3 font-mono text-sm">${transaction.card_masked || '****-****-****-****'}</td>
                    <td class="px-6 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-bold ${statusColor}">
                            ${transaction.status.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-bold ${payoutColor}">
                            ${transaction.payout_status.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-3 text-center no-print">
                        <button onclick="printTransaction('${transaction.transaction_id}')" 
                                class="text-blue-600 hover:text-blue-800 p-1" title="Print Receipt">
                            <i class="fas fa-print"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updatePagination(pagination) {
            if (!pagination.total) return;
            
            document.getElementById('showingFrom').textContent = ((currentPage - 1) * 25) + 1;
            document.getElementById('showingTo').textContent = Math.min(currentPage * 25, pagination.total);
            document.getElementById('totalRecords').textContent = pagination.total;
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${pagination.pages}`;
            
            document.getElementById('prevBtn').disabled = !pagination.has_prev;
            document.getElementById('nextBtn').disabled = !pagination.has_next;
        }

        function addHistoryUpdate(type, message) {
            const containers = {
                'mti': 'mtiUpdatesHistory',
                'payout': 'payoutUpdatesHistory',
                'reference': 'referencesHistory'
            };
            
            const container = document.getElementById(containers[type]);
            if (!container) return;
            
            // Clear placeholder
            if (container.innerHTML.includes('Monitoring')) {
                container.innerHTML = '';
            }
            
            const updateDiv = document.createElement('div');
            updateDiv.className = 'text-xs p-1 bg-white rounded border';
            updateDiv.innerHTML = `
                <div class="font-bold">${message}</div>
                <div class="text-gray-500">${new Date().toLocaleTimeString()}</div>
            `;
            
            container.insertBefore(updateDiv, container.firstChild);
            
            // Keep only last 3 updates
            while (container.children.length > 3) {
                container.removeChild(container.lastChild);
            }
        }

        function filterTransactions() {
            currentPage = 1;
            loadTransactions();
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadTransactions();
            }
        }

        function nextPage() {
            currentPage++;
            loadTransactions();
        }

        function printTransaction(transactionId) {
            alert(`Printing receipt for transaction: ${transactionId}`);
            // Here you would fetch the specific transaction and print it
        }

        function printTransactions() {
            window.print();
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/logout';
            }
        }
    </script>
</body>
</html>